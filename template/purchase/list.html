{% extends 'base.html' %}
{% block content %}
<div class="table-container">
  <br>
  <h1 class="title">{{ title2|upper }}</h1>
  <form method="get">
    <input type="text" name="q" value="{{ request.GET.q }}" placeholder="Buscar por proveedor, documento o fecha">
    <button type="submit">Buscar</button>
  </form>
  <table class="styled-table">
    <thead>
      <tr>
        <th>Proveedor</th>
        <th>N.Documento</th>
        <th>Fecha Emisi√≥n</th>
        <th>Subtotal</th>
        <th>IVA</th>
        <th>Total</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for item in purchases %}
      <tr>
        <td>{{ item.supplier.name }}</td>
        <td>{{ item.num_document }}</td>
        <td>{{ item.issue_date|date:"d/m/Y H:i" }}</td>
        <td>${{ item.subtotal }}</td>
        <td>${{ item.iva }}</td>
        <td><strong>${{ item.total }}</strong></td>
        <td class="text-center">
          {% if item.active %}
            <span class="badge bg-success">Activo</span>
          {% else %}
            <span class="badge bg-danger">Inactivo</span>
          {% endif %}
        </td>
        <td class="text-center">
          <button type="button" class="btn btn-sm btn-outline-primary view-detail" data-id="{{ item.id }}">
            üîé Ver
          </button>
          <a href="{% url 'commerce:purchase_update' item.id %}" title="Editar">‚úèÔ∏è</a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="10" style="text-align:center;">No hay compras registradas.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="form-group mt-3">
    <a class="btn blue" href="{% url 'commerce:purchase_create' %}">‚ûï Nueva Compra</a>
  </div>
</div>
<!-- ================= MODAL DETALLE DE COMPRA ================= -->
<div class="modal fade" id="purchaseModal" tabindex="-1" aria-labelledby="purchaseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" id="modalContent">
      <!-- El contenido del detalle se cargar√° din√°micamente aqu√≠ -->
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const modal = new bootstrap.Modal(document.getElementById('purchaseModal'));
  const modalContent = document.getElementById('modalContent');
  // Funci√≥n para obtener el CSRF token de la cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');
  // URL base del detalle
  const baseDetailUrl = "{% url 'commerce:purchase_detail' 0 %}".replace('0/', '');
  const deleteUrlBase = "{% url 'commerce:purchase_delete' 0 %}".replace('0/', '');
  document.querySelectorAll('.view-detail').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      fetch(baseDetailUrl + id + '/', {
        headers: { 'X-CSRFToken': csrftoken }
      })
      .then(response => response.json())
      .then(data => {
        modalContent.innerHTML = data.html;
        modal.show();
      });
    });
  });

  // Delegaci√≥n para imprimir PDF
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('#btnPrintPDF, #btnDelete, #btnAnnul');
    if (!btn) return;
    const id = btn.dataset.id;
    if (btn.id === 'btnPrintPDF') {
      window.open(`/purchase_pdf/${id}/`, '_blank');
      return;
    }
    const isDelete = btn.id === 'btnDelete';
    const action = isDelete ? 'eliminar' : 'anular';
    const url = isDelete ? `/purchase_delete/${id}/` : `/purchase_annul/${id}/`;
    if (!confirm(`¬øSeguro que desea ${action} la compra N¬∞ ${id}?`)) return;
    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json',
      },
    })
    .then(r => r.json())
    .then(data => {
      alert(data.msg);
      // Cerrar modal si est√° abierto
      const modal = bootstrap.Modal.getInstance(document.getElementById('purchaseModal'));
      if (modal) modal.hide();
      // Eliminar la fila de la tabla sin recargar
      if (btn.id === 'btnDelete') {
        // Buscar la fila en la tabla principal
        const row = document.querySelector(`button[data-id='${id}']`)?.closest('tr');
        if (row) row.remove();
      } else {
        // Si es anular, recargar para actualizar estado
        location.reload();
      }
    })
    .catch(() => alert('Ocurri√≥ un error al procesar la solicitud.'));
  });
});
</script>
{% endblock content %}
